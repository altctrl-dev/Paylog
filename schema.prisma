generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                        Int                     @id @default(autoincrement())
  email                     String                  @unique
  full_name                 String
  password_hash             String? // Optional - OAuth users don't have passwords
  role                      String                  @default("standard_user")
  status                    String                  @default("active") // 'pending' | 'active' | 'deactivated' | 'deleted'
  is_active                 Boolean                 @default(true) // DEPRECATED: Use status instead. Kept for migration compatibility.
  created_at                DateTime                @default(now())
  updated_at                DateTime                @updatedAt
  deleted_at                DateTime? // Timestamp for soft deletes
  display_name              String?
  display_picture_url       String?
  initials                  String?
  last_password_change      DateTime? // Track for password expiry policy
  // Invite fields (for status='pending' users)
  invite_token              String?                 @unique // Token for invite link
  invite_expires_at         DateTime? // When the invite expires
  invited_by_id             Int? // User ID who sent the invite
  invited_by                User?                   @relation("UserInviter", fields: [invited_by_id], references: [id])
  invitees                  User[]                  @relation("UserInviter")
  // OAuth accounts
  accounts                  Account[] // OAuth accounts (Microsoft, etc.)
  activity_logs             ActivityLog[]           @relation("ActivityLogger")
  deleted_attachments       InvoiceAttachment[]     @relation("AttachmentDeleter")
  uploaded_attachments      InvoiceAttachment[]     @relation("AttachmentUploader")
  deleted_comments          InvoiceComment[]        @relation("CommentDeleter")
  comments                  InvoiceComment[]        @relation("CommentAuthor")
  created_invoices          Invoice[]               @relation("InvoiceCreator")
  held_invoices             Invoice[]               @relation("InvoiceHolder")
  archived_invoices         Invoice[]               @relation("InvoiceArchiver")
  deleted_invoices          Invoice[]               @relation("InvoiceDeleter")
  rejected_invoices         Invoice[]               @relation("InvoiceRejector")
  created_requests          MasterDataRequest[]     @relation("RequestRequester")
  reviewed_master_requests  MasterDataRequest[]     @relation("RequestReviewer")
  audit_actions             UserAuditLog[]          @relation("AuditActor")
  audit_history             UserAuditLog[]          @relation("AuditTarget")
  granted_visibilities      UserProfileVisibility[] @relation("VisibilityGranter")
  profile_visibilities      UserProfileVisibility[] @relation("UserProfileAccess")
  created_vendors           Vendor[]                @relation("VendorCreatedBy")
  approved_vendors          Vendor[]                @relation("VendorApprovedBy")
  notifications             Notification[]          @relation("UserNotifications")
  created_payments          Payment[]               @relation("PaymentCreator")
  approved_payments         Payment[]               @relation("PaymentApprover")
  sent_invites              UserInvite[]            @relation("UserInvites") // Legacy - will be deprecated
  // Monthly Report System relations
  finalized_reports         ReportPeriod[]          @relation("ReportFinalizer")
  created_advance_payments  AdvancePayment[]        @relation("AdvancePaymentCreator")
  created_credit_notes      CreditNote[]            @relation("CreditNoteCreator")
  deleted_credit_notes      CreditNote[]            @relation("CreditNoteDeleter")
  approved_credit_notes     CreditNote[]            @relation("CreditNoteApprover")
  approved_advance_payments AdvancePayment[]        @relation("AdvancePaymentApprover")
  deleted_advance_payments  AdvancePayment[]        @relation("AdvancePaymentDeleter")

  @@index([role, status], map: "idx_users_role_status")
  @@index([status], map: "idx_users_status")
  @@index([role], map: "idx_users_super_admin")
  @@index([invite_token], map: "idx_users_invite_token")
  @@map("users")
}

model InvoiceProfile {
  id                      Int                     @id @default(autoincrement())
  name                    String
  description             String?
  visible_to_all          Boolean                 @default(true)
  created_at              DateTime                @default(now())
  updated_at              DateTime                @updatedAt
  entity_id               Int
  vendor_id               Int
  category_id             Int
  currency_id             Int
  prepaid_postpaid        String?                 @db.VarChar(10)
  tds_applicable          Boolean                 @default(false)
  tds_percentage          Float?
  billing_frequency       String? // Keep nullable for flexibility
  billing_frequency_unit  String?
  billing_frequency_value Int?
  category                Category                @relation(fields: [category_id], references: [id], onUpdate: NoAction, map: "fk_invoice_profiles_category")
  currency                Currency                @relation(fields: [currency_id], references: [id], onUpdate: NoAction, map: "fk_invoice_profiles_currency")
  entity                  Entity                  @relation(fields: [entity_id], references: [id], onUpdate: NoAction, map: "fk_invoice_profiles_entity")
  vendor                  Vendor                  @relation(fields: [vendor_id], references: [id], onUpdate: NoAction, map: "fk_invoice_profiles_vendor")
  recurring_invoices      Invoice[]               @relation("InvoiceProfileToInvoice")
  visibilities            UserProfileVisibility[]

  @@index([category_id], map: "idx_invoice_profiles_category")
  @@index([currency_id], map: "idx_invoice_profiles_currency")
  @@index([entity_id], map: "idx_invoice_profiles_entity")
  @@index([vendor_id], map: "idx_invoice_profiles_vendor")
  @@map("invoice_profiles")
}

model UserProfileVisibility {
  id         Int            @id @default(autoincrement())
  user_id    Int
  profile_id Int
  granted_by Int
  granted_at DateTime       @default(now())
  granter    User           @relation("VisibilityGranter", fields: [granted_by], references: [id])
  profile    InvoiceProfile @relation(fields: [profile_id], references: [id], onDelete: Cascade)
  user       User           @relation("UserProfileAccess", fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, profile_id], name: "unique_user_profile")
  @@index([user_id], map: "idx_user_profile_visibility_user")
  @@index([profile_id], map: "idx_user_profile_visibility_profile")
  @@index([granted_by], map: "idx_user_profile_visibility_granted_by")
  @@map("user_profile_visibility")
}

model Vendor {
  id            Int      @id @default(autoincrement())
  name          String
  is_active     Boolean  @default(true)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  address       String?
  gst_exemption Boolean  @default(false)
  bank_details  String?

  // Vendor Approval Workflow Fields
  // BUG-007 FIX: Changed default from APPROVED to PENDING_APPROVAL for safety
  // This ensures vendors created without explicit status are pending by default
  status              String    @default("PENDING_APPROVAL") // "PENDING_APPROVAL" | "APPROVED" | "REJECTED"
  created_by_user_id  Int?
  approved_by_user_id Int?
  approved_at         DateTime?
  rejected_reason     String? // Reason for rejection (admin input)
  deleted_at          DateTime? // Soft delete timestamp

  // Relations
  created_by       User?            @relation("VendorCreatedBy", fields: [created_by_user_id], references: [id])
  approved_by      User?            @relation("VendorApprovedBy", fields: [approved_by_user_id], references: [id])
  invoice_profiles InvoiceProfile[]
  invoices         Invoice[]
  advance_payments AdvancePayment[]

  @@index([status], map: "idx_vendors_status")
  @@index([created_by_user_id], map: "idx_vendors_created_by")
  @@index([approved_by_user_id], map: "idx_vendors_approved_by")
  @@index([deleted_at], map: "idx_vendors_deleted")
  @@map("vendors")
}

model Category {
  id               Int              @id @default(autoincrement())
  name             String
  is_active        Boolean          @default(true)
  created_at       DateTime         @default(now())
  updated_at       DateTime         @updatedAt
  description      String
  invoice_profiles InvoiceProfile[]
  invoices         Invoice[]

  @@map("categories")
}

// SubEntity model removed - replaced by Entity in master data

model PaymentType {
  id                 Int              @id @default(autoincrement())
  name               String
  description        String?
  requires_reference Boolean          @default(false)
  is_active          Boolean          @default(true)
  created_at         DateTime         @default(now())
  updated_at         DateTime         @updatedAt
  payments           Payment[]
  advance_payments   AdvancePayment[]

  @@map("payment_types")
}

model Invoice {
  id                     Int                 @id @default(autoincrement())
  invoice_number         String
  vendor_id              Int
  category_id            Int?
  invoice_amount         Float
  invoice_date           DateTime?
  invoice_received_date  DateTime?
  due_date               DateTime?
  // Monthly Report System: Which month's report this invoice belongs to
  // Defaults to invoice_received_date month; can differ for late entries
  reporting_month        DateTime?
  period_start           DateTime?
  period_end             DateTime?
  tds_applicable         Boolean             @default(false)
  tds_percentage         Float?
  tds_rounded            Boolean             @default(false)
  notes                  String?
  status                 String              @default("pending_approval")
  hold_reason            String?
  hold_by                Int?
  hold_at                DateTime?
  submission_count       Int                 @default(1)
  last_submission_at     DateTime            @default(now())
  rejection_reason       String?
  rejected_by            Int?
  rejected_at            DateTime?
  // Archive fields (soft archive with file move)
  is_archived            Boolean             @default(false)
  archived_by            Int?
  archived_at            DateTime?
  archived_reason        String?
  // Soft delete fields (for recovery before permanent deletion)
  deleted_at             DateTime?
  deleted_by             Int?
  deleted_reason         String?
  recovery_deadline      DateTime? // Auto-permanent-delete after this date
  created_by             Int
  created_at             DateTime            @default(now())
  updated_at             DateTime            @updatedAt
  currency_id            Int?
  entity_id              Int?
  description            String?
  invoice_name           String? // For non-recurring: user-entered name; For recurring: auto-populated from invoice_profile.name
  // Invoice Type
  is_recurring           Boolean             @default(false)
  invoice_profile_id     Int?
  // Invoice Pending: Payment recorded but invoice details not yet received
  // When true: invoice_number is placeholder (e.g., "PENDING-xxx"), invoice_date/due_date may be null
  invoice_pending        Boolean             @default(false)
  invoice_completed_at   DateTime? // When invoice details were added (invoice_pending set to false)
  // Pending payment data (JSON) - stores payment details submitted during invoice creation
  // Will be processed when invoice is approved (for standard users)
  pending_payment_data   Json?
  // Relations
  activity_logs          ActivityLog[]
  attachments            InvoiceAttachment[]
  comments               InvoiceComment[]
  category               Category?           @relation(fields: [category_id], references: [id])
  creator                User                @relation("InvoiceCreator", fields: [created_by], references: [id])
  currency               Currency?           @relation(fields: [currency_id], references: [id], onUpdate: NoAction)
  entity                 Entity?             @relation(fields: [entity_id], references: [id], onUpdate: NoAction)
  holder                 User?               @relation("InvoiceHolder", fields: [hold_by], references: [id], onDelete: Restrict)
  archiver               User?               @relation("InvoiceArchiver", fields: [archived_by], references: [id], onDelete: Restrict)
  deleter                User?               @relation("InvoiceDeleter", fields: [deleted_by], references: [id], onDelete: Restrict)
  invoice_profile        InvoiceProfile?     @relation("InvoiceProfileToInvoice", fields: [invoice_profile_id], references: [id], onDelete: SetNull)
  rejector               User?               @relation("InvoiceRejector", fields: [rejected_by], references: [id], onDelete: Restrict)
  vendor                 Vendor              @relation(fields: [vendor_id], references: [id])
  payments               Payment[]
  credit_notes           CreditNote[]
  // Monthly Report System: Advance payment that was linked to this invoice
  linked_advance_payment AdvancePayment?

  @@unique([invoice_number, vendor_id], map: "idx_invoices_number_vendor")
  @@index([status], map: "idx_invoices_status")
  @@index([is_archived], map: "idx_invoices_archived")
  @@index([deleted_at], map: "idx_invoices_deleted")
  @@index([submission_count], map: "idx_invoices_submission_count")
  @@index([created_at], map: "idx_invoices_created_at")
  @@index([currency_id], map: "idx_invoices_currency")
  @@index([entity_id], map: "idx_invoices_entity")
  @@index([is_recurring], map: "idx_invoices_recurring")
  @@index([invoice_profile_id], map: "idx_invoices_invoice_profile")
  @@index([reporting_month], map: "idx_invoices_reporting_month")
  @@index([invoice_pending], map: "idx_invoices_pending")
  @@map("invoices")
}

model Payment {
  id                 Int      @id @default(autoincrement())
  invoice_id         Int
  payment_type_id    Int?
  amount_paid        Float
  payment_date       DateTime
  payment_reference  String? // Transaction reference number
  status             String   @default("pending")
  tds_amount_applied Float? // Actual TDS deducted at payment time
  tds_rounded        Boolean  @default(false) // Whether ceiling rounding was applied
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt

  // Payment Approval Workflow Fields
  created_by_user_id  Int?
  approved_by_user_id Int?
  approved_at         DateTime?
  rejection_reason    String?

  // Relations
  invoice      Invoice      @relation(fields: [invoice_id], references: [id], onDelete: Cascade)
  payment_type PaymentType? @relation(fields: [payment_type_id], references: [id])
  created_by   User?        @relation("PaymentCreator", fields: [created_by_user_id], references: [id])
  approved_by  User?        @relation("PaymentApprover", fields: [approved_by_user_id], references: [id])

  @@index([invoice_id], map: "idx_payments_invoice")
  @@index([payment_type_id], map: "idx_payments_type")
  @@index([status], map: "idx_payments_status")
  @@index([payment_date], map: "idx_payments_date")
  @@index([created_by_user_id], map: "idx_payments_created_by")
  @@index([approved_by_user_id], map: "idx_payments_approved_by")
  @@map("payments")
}

model MasterDataRequest {
  id                  Int                 @id @default(autoincrement())
  entity_type         String
  status              String              @default("draft")
  requester_id        Int
  request_data        String
  reviewer_id         Int?
  reviewed_at         DateTime?
  rejection_reason    String?
  admin_edits         String?
  admin_notes         String?
  resubmission_count  Int                 @default(0)
  previous_attempt_id Int?
  superseded_by_id    Int?
  created_entity_id   String?
  created_at          DateTime            @default(now())
  updated_at          DateTime            @updatedAt
  previous_attempt    MasterDataRequest?  @relation("RequestResubmission", fields: [previous_attempt_id], references: [id])
  resubmissions       MasterDataRequest[] @relation("RequestResubmission")
  requester           User                @relation("RequestRequester", fields: [requester_id], references: [id])
  reviewer            User?               @relation("RequestReviewer", fields: [reviewer_id], references: [id], onDelete: Restrict)
  superseded_by       MasterDataRequest?  @relation("RequestSupersession", fields: [superseded_by_id], references: [id])
  supersedes          MasterDataRequest[] @relation("RequestSupersession")

  @@index([entity_type, status], map: "idx_master_data_requests_type_status")
  @@index([requester_id], map: "idx_master_data_requests_requester")
  @@index([reviewer_id], map: "idx_master_data_requests_reviewer")
  @@index([status], map: "idx_master_data_requests_status")
  @@index([created_at], map: "idx_master_data_requests_created_at")
  @@map("master_data_requests")
}

model InvoiceAttachment {
  id            String    @id @default(cuid())
  invoice_id    Int
  file_name     String
  original_name String
  file_size     Int
  mime_type     String
  storage_path  String
  uploaded_by   Int
  uploaded_at   DateTime  @default(now())
  deleted_at    DateTime?
  deleted_by    Int?
  scan_status   String?
  scan_result   String?
  deleter       User?     @relation("AttachmentDeleter", fields: [deleted_by], references: [id], onDelete: Restrict)
  invoice       Invoice   @relation(fields: [invoice_id], references: [id], onDelete: Cascade)
  uploader      User      @relation("AttachmentUploader", fields: [uploaded_by], references: [id])

  @@index([invoice_id, deleted_at], map: "idx_attachments_invoice_active")
  @@index([uploaded_by], map: "idx_attachments_uploader")
  @@index([uploaded_at], map: "idx_attachments_time")
  @@map("invoice_attachments")
}

model InvoiceComment {
  id         String    @id @default(cuid())
  invoice_id Int
  user_id    Int
  content    String
  is_edited  Boolean   @default(false)
  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt
  deleted_at DateTime?
  deleted_by Int?
  deleter    User?     @relation("CommentDeleter", fields: [deleted_by], references: [id], onDelete: Restrict)
  invoice    Invoice   @relation(fields: [invoice_id], references: [id], onDelete: Cascade)
  author     User      @relation("CommentAuthor", fields: [user_id], references: [id])

  @@index([invoice_id, deleted_at], map: "idx_comments_invoice_active")
  @@index([user_id], map: "idx_comments_author")
  @@index([created_at], map: "idx_comments_time")
  @@map("invoice_comments")
}

model ActivityLog {
  id         String   @id @default(cuid())
  invoice_id Int
  user_id    Int?
  action     String
  old_data   String?
  new_data   String?
  ip_address String?
  user_agent String?
  created_at DateTime @default(now())
  invoice    Invoice  @relation(fields: [invoice_id], references: [id], onDelete: Cascade)
  user       User?    @relation("ActivityLogger", fields: [user_id], references: [id])

  @@index([invoice_id, created_at], map: "idx_activity_invoice_time")
  @@index([user_id], map: "idx_activity_user")
  @@index([action], map: "idx_activity_action")
  @@index([created_at], map: "idx_activity_time")
  @@map("activity_logs")
}

model SchemaMigration {
  id             Int      @id @default(autoincrement())
  migration_name String   @unique
  applied_at     DateTime @default(now())
  description    String?

  @@map("schema_migrations")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model Currency {
  id               Int              @id @default(autoincrement())
  code             String           @unique @db.VarChar(3)
  name             String           @db.VarChar(255)
  symbol           String           @db.VarChar(10)
  is_active        Boolean          @default(false)
  created_at       DateTime         @default(now()) @db.Timestamp(6)
  updated_at       DateTime         @default(now()) @db.Timestamp(6)
  invoice_profiles InvoiceProfile[]
  invoices         Invoice[]

  @@index([code], map: "idx_currencies_code")
  @@map("currencies")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model Entity {
  id               Int              @id @default(autoincrement())
  name             String           @db.VarChar(255)
  description      String?
  address          String
  country          String           @db.VarChar(2)
  is_active        Boolean          @default(true)
  created_at       DateTime         @default(now()) @db.Timestamp(6)
  updated_at       DateTime         @default(now()) @db.Timestamp(6)
  invoice_profiles InvoiceProfile[]
  invoices         Invoice[]

  @@index([country], map: "idx_entities_country")
  @@index([name], map: "idx_entities_name")
  @@map("entities")
}

model UserAuditLog {
  id             String   @id @default(cuid())
  target_user_id Int
  actor_user_id  Int?
  event_type     String
  old_data       String?
  new_data       String?
  ip_address     String?
  user_agent     String?
  created_at     DateTime @default(now())
  actor          User?    @relation("AuditActor", fields: [actor_user_id], references: [id])
  target_user    User     @relation("AuditTarget", fields: [target_user_id], references: [id], onDelete: Cascade)

  @@index([target_user_id, created_at], map: "idx_user_audit_target_time")
  @@index([actor_user_id], map: "idx_user_audit_actor")
  @@index([event_type], map: "idx_user_audit_event")
  @@index([created_at], map: "idx_user_audit_time")
  @@map("user_audit_logs")
}

/// Notification model for user notifications
/// Notifications are created for various events like invoice approvals, master data requests, etc.
model Notification {
  id             Int       @id @default(autoincrement())
  user_id        Int // Target user to receive notification
  type           String // invoice_pending, invoice_approved, invoice_rejected, master_data_request, etc.
  title          String // Short title
  message        String // Detailed message
  link           String? // Optional link to navigate to
  reference_type String? // invoice, master_data_request, vendor, etc.
  reference_id   Int? // ID of the referenced entity
  is_read        Boolean   @default(false)
  read_at        DateTime?
  created_at     DateTime  @default(now())
  user           User      @relation("UserNotifications", fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, is_read, created_at], map: "idx_notifications_user_unread")
  @@index([user_id, created_at], map: "idx_notifications_user_time")
  @@index([type], map: "idx_notifications_type")
  @@map("notifications")
}

/// System settings for application-wide configuration
/// Key-value store for settings like soft_delete_retention_days
model SystemSetting {
  key        String   @id // Setting key (e.g., "soft_delete_retention_days")
  value      String // Setting value (stored as string, parsed by application)
  updated_at DateTime @default(now()) @updatedAt
  updated_by Int? // User ID who last updated this setting

  @@map("system_settings")
}

/// OAuth Account model for NextAuth
/// Stores OAuth provider tokens and account linking
model Account {
  id                String  @id @default(cuid())
  userId            Int
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId], map: "idx_accounts_user")
  @@map("accounts")
}

/// Verification Token model for NextAuth
/// Used for email verification flows
model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

/// User Invite model
/// Stores pending invitations for new users
model UserInvite {
  id         String    @id @default(cuid())
  token      String    @unique // Unique token for invite link
  email      String // Email address of invited user
  role       String    @default("standard_user") // Role to assign on accept
  expires_at DateTime // When the invite expires (48 hours from creation)
  used_at    DateTime? // When the invite was used (null if not used)
  invited_by Int // User ID who created the invite
  created_at DateTime  @default(now())
  inviter    User      @relation("UserInvites", fields: [invited_by], references: [id])

  @@index([token], map: "idx_user_invites_token")
  @@index([email], map: "idx_user_invites_email")
  @@map("user_invites")
}

// ============================================================================
// MONTHLY REPORT SYSTEM
// ============================================================================

/// Report Period model for Monthly Report System
/// Tracks audit/finalization status for each month's report
/// Stores frozen snapshot JSON when finalized for historical accuracy
model ReportPeriod {
  id              Int       @id @default(autoincrement())
  month           Int // 1-12
  year            Int // 2025, 2026, etc.
  status          String    @default("draft") // "draft" | "finalized" | "submitted"
  finalized_at    DateTime?
  finalized_by_id Int?
  submitted_at    DateTime?
  submitted_to    String? // Email or name of accountant
  // Frozen snapshot of the report at finalization time
  // Contains all invoices and payments grouped by payment type
  snapshot_data   Json?
  notes           String?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  finalized_by User? @relation("ReportFinalizer", fields: [finalized_by_id], references: [id])

  @@unique([month, year], name: "unique_report_period")
  @@index([status], map: "idx_report_periods_status")
  @@index([year, month], map: "idx_report_periods_year_month")
  @@map("report_periods")
}

/// Credit Note model
/// Credit notes issued by vendors to reduce invoice amounts
/// Linked to specific invoice, supports TDS reversal
model CreditNote {
  id                 Int       @id @default(autoincrement())
  invoice_id         Int // Required link to parent invoice
  credit_note_number String // Vendor's credit note reference number
  credit_note_date   DateTime // Date on the credit note
  amount             Float // Credit note amount
  reason             String // Reason for the credit note
  notes              String? // Additional notes
  // TDS reversal support
  tds_applicable     Boolean   @default(false)
  tds_amount         Float? // TDS amount to be reversed
  // File attachment (optional)
  file_name          String?
  file_path          String?
  file_size          Int?
  file_mime_type     String?
  // Reporting
  reporting_month    DateTime? // Which month's report this belongs to
  // Audit fields
  created_by_id      Int
  created_at         DateTime  @default(now())
  updated_at         DateTime  @updatedAt
  // Soft delete
  deleted_at         DateTime?
  deleted_by_id      Int?
  deleted_reason     String?
  // Approval workflow
  status             String    @default("pending_approval") // "pending_approval" | "approved" | "rejected"
  approved_by_id     Int?
  approved_at        DateTime?
  rejection_reason   String?

  // Relations
  invoice     Invoice @relation(fields: [invoice_id], references: [id], onDelete: Cascade)
  created_by  User    @relation("CreditNoteCreator", fields: [created_by_id], references: [id])
  deleted_by  User?   @relation("CreditNoteDeleter", fields: [deleted_by_id], references: [id])
  approved_by User?   @relation("CreditNoteApprover", fields: [approved_by_id], references: [id])

  @@index([invoice_id], map: "idx_credit_notes_invoice")
  @@index([credit_note_date], map: "idx_credit_notes_date")
  @@index([reporting_month], map: "idx_credit_notes_reporting_month")
  @@index([deleted_at], map: "idx_credit_notes_deleted")
  @@index([status], map: "idx_credit_notes_status")
  @@index([approved_by_id], map: "idx_credit_notes_approved_by")
  @@map("credit_notes")
}

/// Advance Payment model for Monthly Report System
/// Records payments made before invoice is received
/// Can be linked to an invoice later when it arrives
model AdvancePayment {
  id                Int       @id @default(autoincrement())
  vendor_id         Int
  description       String // What the payment was for
  amount            Float
  payment_type_id   Int
  payment_date      DateTime
  payment_reference String? // Transaction reference number
  // Which month's report this belongs to (first of the month)
  reporting_month   DateTime
  // When invoice arrives, link it here
  linked_invoice_id Int?      @unique
  linked_at         DateTime?
  notes             String?
  created_by_id     Int?
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt
  // Approval workflow
  status            String    @default("pending_approval") // "pending_approval" | "approved" | "rejected"
  approved_by_id    Int?
  approved_at       DateTime?
  rejection_reason  String?
  // Soft delete fields
  deleted_at        DateTime?
  deleted_by_id     Int?
  deleted_reason    String?

  vendor         Vendor      @relation(fields: [vendor_id], references: [id])
  payment_type   PaymentType @relation(fields: [payment_type_id], references: [id])
  linked_invoice Invoice?    @relation(fields: [linked_invoice_id], references: [id])
  created_by     User?       @relation("AdvancePaymentCreator", fields: [created_by_id], references: [id])
  approved_by    User?       @relation("AdvancePaymentApprover", fields: [approved_by_id], references: [id])
  deleted_by     User?       @relation("AdvancePaymentDeleter", fields: [deleted_by_id], references: [id])

  @@index([vendor_id], map: "idx_advance_payments_vendor")
  @@index([reporting_month], map: "idx_advance_payments_reporting_month")
  @@index([linked_invoice_id], map: "idx_advance_payments_linked_invoice")
  @@index([payment_type_id], map: "idx_advance_payments_payment_type")
  @@index([status], map: "idx_advance_payments_status")
  @@index([approved_by_id], map: "idx_advance_payments_approved_by")
  @@index([deleted_at], map: "idx_advance_payments_deleted")
  @@map("advance_payments")
}
