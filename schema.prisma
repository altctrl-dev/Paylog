generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       Int                     @id @default(autoincrement())
  email                    String                  @unique
  full_name                String
  password_hash            String
  role                     String                  @default("standard_user")
  is_active                Boolean                 @default(true)
  created_at               DateTime                @default(now())
  updated_at               DateTime                @updatedAt
  display_name             String?
  display_picture_url      String?
  initials                 String?
  activity_logs            ActivityLog[]           @relation("ActivityLogger")
  deleted_attachments      InvoiceAttachment[]     @relation("AttachmentDeleter")
  uploaded_attachments     InvoiceAttachment[]     @relation("AttachmentUploader")
  deleted_comments         InvoiceComment[]        @relation("CommentDeleter")
  comments                 InvoiceComment[]        @relation("CommentAuthor")
  created_invoices         Invoice[]               @relation("InvoiceCreator")
  held_invoices            Invoice[]               @relation("InvoiceHolder")
  archived_invoices        Invoice[]               @relation("InvoiceArchiver")
  rejected_invoices        Invoice[]               @relation("InvoiceRejector")
  created_requests         MasterDataRequest[]     @relation("RequestRequester")
  reviewed_master_requests MasterDataRequest[]     @relation("RequestReviewer")
  audit_actions            UserAuditLog[]          @relation("AuditActor")
  audit_history            UserAuditLog[]          @relation("AuditTarget")
  granted_visibilities     UserProfileVisibility[] @relation("VisibilityGranter")
  profile_visibilities     UserProfileVisibility[] @relation("UserProfileAccess")
  created_vendors          Vendor[]                @relation("VendorCreatedBy")
  approved_vendors         Vendor[]                @relation("VendorApprovedBy")
  notifications            Notification[]          @relation("UserNotifications")
  created_payments         Payment[]               @relation("PaymentCreator")
  approved_payments        Payment[]               @relation("PaymentApprover")

  @@index([role, is_active], map: "idx_users_role_active")
  @@index([role], map: "idx_users_super_admin")
  @@map("users")
}

model InvoiceProfile {
  id                      Int                     @id @default(autoincrement())
  name                    String
  description             String?
  visible_to_all          Boolean                 @default(true)
  created_at              DateTime                @default(now())
  updated_at              DateTime                @updatedAt
  entity_id               Int
  vendor_id               Int
  category_id             Int
  currency_id             Int
  prepaid_postpaid        String?                 @db.VarChar(10)
  tds_applicable          Boolean                 @default(false)
  tds_percentage          Float?
  billing_frequency       String? // Keep nullable for flexibility
  billing_frequency_unit  String?
  billing_frequency_value Int?
  category                Category                @relation(fields: [category_id], references: [id], onUpdate: NoAction, map: "fk_invoice_profiles_category")
  currency                Currency                @relation(fields: [currency_id], references: [id], onUpdate: NoAction, map: "fk_invoice_profiles_currency")
  entity                  Entity                  @relation(fields: [entity_id], references: [id], onUpdate: NoAction, map: "fk_invoice_profiles_entity")
  vendor                  Vendor                  @relation(fields: [vendor_id], references: [id], onUpdate: NoAction, map: "fk_invoice_profiles_vendor")
  recurring_invoices      Invoice[]               @relation("InvoiceProfileToInvoice")
  visibilities            UserProfileVisibility[]

  @@index([category_id], map: "idx_invoice_profiles_category")
  @@index([currency_id], map: "idx_invoice_profiles_currency")
  @@index([entity_id], map: "idx_invoice_profiles_entity")
  @@index([vendor_id], map: "idx_invoice_profiles_vendor")
  @@map("invoice_profiles")
}

model UserProfileVisibility {
  id         Int            @id @default(autoincrement())
  user_id    Int
  profile_id Int
  granted_by Int
  granted_at DateTime       @default(now())
  granter    User           @relation("VisibilityGranter", fields: [granted_by], references: [id])
  profile    InvoiceProfile @relation(fields: [profile_id], references: [id], onDelete: Cascade)
  user       User           @relation("UserProfileAccess", fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, profile_id], name: "unique_user_profile")
  @@index([user_id], map: "idx_user_profile_visibility_user")
  @@index([profile_id], map: "idx_user_profile_visibility_profile")
  @@index([granted_by], map: "idx_user_profile_visibility_granted_by")
  @@map("user_profile_visibility")
}

model Vendor {
  id            Int      @id @default(autoincrement())
  name          String
  is_active     Boolean  @default(true)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  address       String?
  gst_exemption Boolean  @default(false)
  bank_details  String?

  // Vendor Approval Workflow Fields
  status              String    @default("APPROVED") // "PENDING_APPROVAL" | "APPROVED" | "REJECTED"
  created_by_user_id  Int?
  approved_by_user_id Int?
  approved_at         DateTime?
  rejected_reason     String? // Reason for rejection (admin input)
  deleted_at          DateTime? // Soft delete timestamp

  // Relations
  created_by       User?            @relation("VendorCreatedBy", fields: [created_by_user_id], references: [id])
  approved_by      User?            @relation("VendorApprovedBy", fields: [approved_by_user_id], references: [id])
  invoice_profiles InvoiceProfile[]
  invoices         Invoice[]

  @@index([status], map: "idx_vendors_status")
  @@index([created_by_user_id], map: "idx_vendors_created_by")
  @@index([approved_by_user_id], map: "idx_vendors_approved_by")
  @@index([deleted_at], map: "idx_vendors_deleted")
  @@map("vendors")
}

model Category {
  id               Int              @id @default(autoincrement())
  name             String
  is_active        Boolean          @default(true)
  created_at       DateTime         @default(now())
  updated_at       DateTime         @updatedAt
  description      String
  invoice_profiles InvoiceProfile[]
  invoices         Invoice[]

  @@map("categories")
}

// SubEntity model removed - replaced by Entity in master data

model PaymentType {
  id                 Int       @id @default(autoincrement())
  name               String
  description        String?
  requires_reference Boolean   @default(false)
  is_active          Boolean   @default(true)
  created_at         DateTime  @default(now())
  updated_at         DateTime  @updatedAt
  payments           Payment[]

  @@map("payment_types")
}

model Invoice {
  id                    Int                 @id @default(autoincrement())
  invoice_number        String
  vendor_id             Int
  category_id           Int?
  invoice_amount        Float
  invoice_date          DateTime?
  invoice_received_date DateTime?
  due_date              DateTime?
  period_start          DateTime?
  period_end            DateTime?
  tds_applicable        Boolean             @default(false)
  tds_percentage        Float?
  tds_rounded           Boolean             @default(false)
  notes                 String?
  status                String              @default("pending_approval")
  hold_reason           String?
  hold_by               Int?
  hold_at               DateTime?
  submission_count      Int                 @default(1)
  last_submission_at    DateTime            @default(now())
  rejection_reason      String?
  rejected_by           Int?
  rejected_at           DateTime?
  // Archive fields (soft archive with file move)
  is_archived           Boolean             @default(false)
  archived_by           Int?
  archived_at           DateTime?
  archived_reason       String?
  created_by            Int
  created_at            DateTime            @default(now())
  updated_at            DateTime            @updatedAt
  currency_id           Int?
  entity_id             Int?
  description           String?
  invoice_name          String? // For non-recurring: user-entered name; For recurring: auto-populated from invoice_profile.name
  // Invoice Type
  is_recurring          Boolean             @default(false)
  invoice_profile_id    Int?
  // Relations
  activity_logs         ActivityLog[]
  attachments           InvoiceAttachment[]
  comments              InvoiceComment[]
  category              Category?           @relation(fields: [category_id], references: [id])
  creator               User                @relation("InvoiceCreator", fields: [created_by], references: [id])
  currency              Currency?           @relation(fields: [currency_id], references: [id], onUpdate: NoAction)
  entity                Entity?             @relation(fields: [entity_id], references: [id], onUpdate: NoAction)
  holder                User?               @relation("InvoiceHolder", fields: [hold_by], references: [id], onDelete: Restrict)
  archiver              User?               @relation("InvoiceArchiver", fields: [archived_by], references: [id], onDelete: Restrict)
  invoice_profile       InvoiceProfile?     @relation("InvoiceProfileToInvoice", fields: [invoice_profile_id], references: [id], onDelete: SetNull)
  rejector              User?               @relation("InvoiceRejector", fields: [rejected_by], references: [id], onDelete: Restrict)
  vendor                Vendor              @relation(fields: [vendor_id], references: [id])
  payments              Payment[]

  @@unique([invoice_number, vendor_id], map: "idx_invoices_number_vendor")
  @@index([status], map: "idx_invoices_status")
  @@index([is_archived], map: "idx_invoices_archived")
  @@index([submission_count], map: "idx_invoices_submission_count")
  @@index([created_at], map: "idx_invoices_created_at")
  @@index([currency_id], map: "idx_invoices_currency")
  @@index([entity_id], map: "idx_invoices_entity")
  @@index([is_recurring], map: "idx_invoices_recurring")
  @@index([invoice_profile_id], map: "idx_invoices_invoice_profile")
  @@map("invoices")
}

model Payment {
  id                 Int      @id @default(autoincrement())
  invoice_id         Int
  payment_type_id    Int?
  amount_paid        Float
  payment_date       DateTime
  payment_reference  String? // Transaction reference number
  status             String   @default("pending")
  tds_amount_applied Float? // Actual TDS deducted at payment time
  tds_rounded        Boolean  @default(false) // Whether ceiling rounding was applied
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt

  // Payment Approval Workflow Fields
  created_by_user_id  Int?
  approved_by_user_id Int?
  approved_at         DateTime?
  rejection_reason    String?

  // Relations
  invoice      Invoice      @relation(fields: [invoice_id], references: [id], onDelete: Cascade)
  payment_type PaymentType? @relation(fields: [payment_type_id], references: [id])
  created_by   User?        @relation("PaymentCreator", fields: [created_by_user_id], references: [id])
  approved_by  User?        @relation("PaymentApprover", fields: [approved_by_user_id], references: [id])

  @@index([invoice_id], map: "idx_payments_invoice")
  @@index([payment_type_id], map: "idx_payments_type")
  @@index([status], map: "idx_payments_status")
  @@index([payment_date], map: "idx_payments_date")
  @@index([created_by_user_id], map: "idx_payments_created_by")
  @@index([approved_by_user_id], map: "idx_payments_approved_by")
  @@map("payments")
}

model MasterDataRequest {
  id                  Int                 @id @default(autoincrement())
  entity_type         String
  status              String              @default("draft")
  requester_id        Int
  request_data        String
  reviewer_id         Int?
  reviewed_at         DateTime?
  rejection_reason    String?
  admin_edits         String?
  admin_notes         String?
  resubmission_count  Int                 @default(0)
  previous_attempt_id Int?
  superseded_by_id    Int?
  created_entity_id   String?
  created_at          DateTime            @default(now())
  updated_at          DateTime            @updatedAt
  previous_attempt    MasterDataRequest?  @relation("RequestResubmission", fields: [previous_attempt_id], references: [id])
  resubmissions       MasterDataRequest[] @relation("RequestResubmission")
  requester           User                @relation("RequestRequester", fields: [requester_id], references: [id])
  reviewer            User?               @relation("RequestReviewer", fields: [reviewer_id], references: [id], onDelete: Restrict)
  superseded_by       MasterDataRequest?  @relation("RequestSupersession", fields: [superseded_by_id], references: [id])
  supersedes          MasterDataRequest[] @relation("RequestSupersession")

  @@index([entity_type, status], map: "idx_master_data_requests_type_status")
  @@index([requester_id], map: "idx_master_data_requests_requester")
  @@index([reviewer_id], map: "idx_master_data_requests_reviewer")
  @@index([status], map: "idx_master_data_requests_status")
  @@index([created_at], map: "idx_master_data_requests_created_at")
  @@map("master_data_requests")
}

model InvoiceAttachment {
  id            String    @id @default(cuid())
  invoice_id    Int
  file_name     String
  original_name String
  file_size     Int
  mime_type     String
  storage_path  String
  uploaded_by   Int
  uploaded_at   DateTime  @default(now())
  deleted_at    DateTime?
  deleted_by    Int?
  scan_status   String?
  scan_result   String?
  deleter       User?     @relation("AttachmentDeleter", fields: [deleted_by], references: [id], onDelete: Restrict)
  invoice       Invoice   @relation(fields: [invoice_id], references: [id], onDelete: Cascade)
  uploader      User      @relation("AttachmentUploader", fields: [uploaded_by], references: [id])

  @@index([invoice_id, deleted_at], map: "idx_attachments_invoice_active")
  @@index([uploaded_by], map: "idx_attachments_uploader")
  @@index([uploaded_at], map: "idx_attachments_time")
  @@map("invoice_attachments")
}

model InvoiceComment {
  id         String    @id @default(cuid())
  invoice_id Int
  user_id    Int
  content    String
  is_edited  Boolean   @default(false)
  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt
  deleted_at DateTime?
  deleted_by Int?
  deleter    User?     @relation("CommentDeleter", fields: [deleted_by], references: [id], onDelete: Restrict)
  invoice    Invoice   @relation(fields: [invoice_id], references: [id], onDelete: Cascade)
  author     User      @relation("CommentAuthor", fields: [user_id], references: [id])

  @@index([invoice_id, deleted_at], map: "idx_comments_invoice_active")
  @@index([user_id], map: "idx_comments_author")
  @@index([created_at], map: "idx_comments_time")
  @@map("invoice_comments")
}

model ActivityLog {
  id         String   @id @default(cuid())
  invoice_id Int
  user_id    Int?
  action     String
  old_data   String?
  new_data   String?
  ip_address String?
  user_agent String?
  created_at DateTime @default(now())
  invoice    Invoice  @relation(fields: [invoice_id], references: [id], onDelete: Cascade)
  user       User?    @relation("ActivityLogger", fields: [user_id], references: [id])

  @@index([invoice_id, created_at], map: "idx_activity_invoice_time")
  @@index([user_id], map: "idx_activity_user")
  @@index([action], map: "idx_activity_action")
  @@index([created_at], map: "idx_activity_time")
  @@map("activity_logs")
}

model SchemaMigration {
  id             Int      @id @default(autoincrement())
  migration_name String   @unique
  applied_at     DateTime @default(now())
  description    String?

  @@map("schema_migrations")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model Currency {
  id               Int              @id @default(autoincrement())
  code             String           @unique @db.VarChar(3)
  name             String           @db.VarChar(255)
  symbol           String           @db.VarChar(10)
  is_active        Boolean          @default(false)
  created_at       DateTime         @default(now()) @db.Timestamp(6)
  updated_at       DateTime         @default(now()) @db.Timestamp(6)
  invoice_profiles InvoiceProfile[]
  invoices         Invoice[]

  @@index([code], map: "idx_currencies_code")
  @@map("currencies")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model Entity {
  id               Int              @id @default(autoincrement())
  name             String           @db.VarChar(255)
  description      String?
  address          String
  country          String           @db.VarChar(2)
  is_active        Boolean          @default(true)
  created_at       DateTime         @default(now()) @db.Timestamp(6)
  updated_at       DateTime         @default(now()) @db.Timestamp(6)
  invoice_profiles InvoiceProfile[]
  invoices         Invoice[]

  @@index([country], map: "idx_entities_country")
  @@index([name], map: "idx_entities_name")
  @@map("entities")
}

model UserAuditLog {
  id             String   @id @default(cuid())
  target_user_id Int
  actor_user_id  Int?
  event_type     String
  old_data       String?
  new_data       String?
  ip_address     String?
  user_agent     String?
  created_at     DateTime @default(now())
  actor          User?    @relation("AuditActor", fields: [actor_user_id], references: [id])
  target_user    User     @relation("AuditTarget", fields: [target_user_id], references: [id], onDelete: Cascade)

  @@index([target_user_id, created_at], map: "idx_user_audit_target_time")
  @@index([actor_user_id], map: "idx_user_audit_actor")
  @@index([event_type], map: "idx_user_audit_event")
  @@index([created_at], map: "idx_user_audit_time")
  @@map("user_audit_logs")
}

/// Notification model for user notifications
/// Notifications are created for various events like invoice approvals, master data requests, etc.
model Notification {
  id             Int       @id @default(autoincrement())
  user_id        Int // Target user to receive notification
  type           String // invoice_pending, invoice_approved, invoice_rejected, master_data_request, etc.
  title          String // Short title
  message        String // Detailed message
  link           String? // Optional link to navigate to
  reference_type String? // invoice, master_data_request, vendor, etc.
  reference_id   Int? // ID of the referenced entity
  is_read        Boolean   @default(false)
  read_at        DateTime?
  created_at     DateTime  @default(now())
  user           User      @relation("UserNotifications", fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, is_read, created_at], map: "idx_notifications_user_unread")
  @@index([user_id, created_at], map: "idx_notifications_user_time")
  @@index([type], map: "idx_notifications_type")
  @@map("notifications")
}
